---
title: "gather"
author: "Anh"
date: "10/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(readxl)
library(janitor)
library(tidycensus)
library(viridis)
library(lubridate)
library(janitor)
library(scales)

```

```{r juvenile}
juvenile_stats_2014 <- read_excel("raw_data/Juvenile_stats_2014.xlsx") %>%
  clean_names() %>% 
  select(!total) %>%
  mutate(year = 2014)

juvenile_stats_2015 <- read_excel("raw_data/Juvenile_stats_2015.xlsx") %>%
  clean_names() %>% 
  select(!grand_total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2015)

juvenile_stats_2016 <- read_excel("raw_data/Juvenile_stats_2016.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2016) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_stats_2017 <- read_excel("raw_data/Juvenile_stats_2017.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_stats_2018 <- read_excel("raw_data/Juvenile_stats_2018.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2018) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_stats_2019 <- read_excel("raw_data/Juvenile_stats_2019.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2019) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_6_years <- 
  bind_rows(list(juvenile_stats_2014, juvenile_stats_2015,
                 juvenile_stats_2016, juvenile_stats_2017,
                 juvenile_stats_2018, juvenile_stats_2019),
            .id = "year") %>% 
  mutate(year = as.numeric(year) + 2013) %>%
  group_by(year)

saveRDS(juvenile_stats_2014, file = "shiny-app/data/juvenile_stats_2014.rds")
saveRDS(juvenile_6_years, file = "shiny-app/data/juvenile_6_years.rds")
```


```{r county}
# Find variables in ACS
variable_code <- load_variables(2018, "acs5", cache = TRUE)
View(variable_code)

# Getting American Community Survey data 2014-2018
# Median income by county
county_income <- get_acs(geography = "county",
              variables = c(medincome = "B19013_001"),
              state = "MA",
              year = 2018)

saveRDS(county_income, file = "shiny-app/data/county_income.rds")

glimpse(county_income)

get_acs(geography = "county",
              variables = c(medincome = "B19013_001"),
              state = "MA",
              year = 2018) %>%
  mutate(NAME = gsub(" County, Massachusetts", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 1) +
  labs(title = "Household income by county in MA",
       subtitle = "2014-2018 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")

#margin of error is small for Berkshire and Middlesex county. For Middlesex, median household income according to 2014-2018 American Community Survey fell between 95,000 and 100,000 US dollars. For Berkshire, median household income fell between 55,000 and 60,000 US dollars per year. In other words, median household income in Berkshire is roughly half of the median household income in Middlesex. 

```
```{r middlesex}
# racial population by county
racial_variables <- c(White = "B03002_003", Black = "B03002_004",
                      Asian = "B03002_006", Hispanic = "B03002_012")

county_race <- get_acs(geography = "county",
                       state = "MA",
                       variables = racial_variables,
                       summary_var = "B03002_001",
                       year = 2018) %>%
  filter(NAME == "Middlesex County, Massachusetts")
glimpse(county_race)

#racial proportion by county 
county_race_prop <- county_race %>%
  mutate(pct = 100 * (estimate/summary_est)) %>%
  select(NAME, variable, pct)

county_race_prop

# middlesex racial proportion
middlesex_race <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Middlesex County",
                  geometry = TRUE,
                  summary_var = "B03002_001")
middlesex_race

middlesex_race_map <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Middlesex County",
                  geometry = TRUE,
                  summary_var = "B03002_001") %>%
  mutate(Percent = 100 * (estimate / summary_est)) %>%
  ggplot(aes(fill = Percent, color = Percent)) +
  facet_wrap(~ variable) +
  geom_sf() +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) +
  labs(title = "Racial geography of Middlesex County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

middlesex_race_map
```

```{r berkshire}
# berkshire racial proportion

berkshire_race <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Berkshire County",
                  geometry = TRUE,
                  summary_var = "B03002_001")
berkshire_race

berkshire_race_map <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Berkshire County",
                  geometry = TRUE,
                  summary_var = "B03002_001") %>%
  mutate(Percent = 100 * (estimate / summary_est)) %>%
  ggplot(aes(fill = Percent, color = Percent)) +
  facet_wrap(~ variable) +
  geom_sf() +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) +
  labs(title = "Racial geography of Berkshire County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

berkshire_race_map

```

```{r incomemap}

# Median Income value for Middlesex 

middlesex_income_value <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Middlesex County",
                    geometry = TRUE)

middlesex_income_map <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Middlesex County",
                    geometry = TRUE) %>%
  ggplot(aes(fill = estimate, color = estimate)) +
  geom_sf() +
  scale_fill_viridis_c(name = "Median Income", direction = -1) +
  scale_color_viridis_c(name = "Median Income", direction = -1) +
  labs(title = "Median income distribution in Middlesex County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

middlesex_income_map


```

```{r}
# Median Income value for Berkshire 

berkshire_income_value <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Berkshire County",
                    geometry = TRUE)

berkshire_income_map <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Berkshire County",
                    geometry = TRUE) %>%
  ggplot(aes(fill = estimate, color = estimate)) +
  geom_sf() +
  scale_fill_viridis_c(name = "Median Income", direction = -1) +
  scale_color_viridis_c(name = "Median Income", direction = -1) +
  labs(title = "Median income distribution in Berkshire County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

berkshire_income_map
```

```{r}
  
          # berkshire racial geography map
      
      berkshire_race_map <- get_acs(geography = "tract",
                                    variables = racial_variables, 
                                    year = 2018,
                                    state = "MA",
                                    county = "Berkshire County",
                                    geometry = TRUE,
                                    summary_var = "B03002_001") %>%
        mutate(Percent = 100 * (estimate / summary_est)) %>%
        ggplot(aes(fill = Percent, color = Percent)) +
        facet_wrap(~ variable) +
        geom_sf() +
        scale_fill_viridis_c(direction = -1) +
        scale_color_viridis_c(direction = -1) +
        labs(title = "Racial geography of Berkshire County, MA",
             caption = "Source: American Community Survey 2014-2018") +
        theme_void()
      # middlesex income
      middlesex_income_map <- get_acs(geography = "tract", 
                                      variables = "B19013_001", 
                                      state = "MA",
                                      county = "Middlesex County",
                                      geometry = TRUE) %>%
        ggplot(aes(fill = estimate, color = estimate)) +
        geom_sf() +
        scale_fill_viridis_c(name = "Median Income", direction = -1) +
        scale_color_viridis_c(name = "Median Income", direction = -1) +
        labs(title = "Median income distribution in Middlesex County, MA",
             caption = "Source: American Community Survey 2014-2018") +
        theme_void()
      
      # berkshire income 
      berkshire_income_map <- get_acs(geography = "tract", 
                                      variables = "B19013_001", 
                                      state = "MA",
                                      county = "Berkshire County",
                                      geometry = TRUE) %>%
        ggplot(aes(fill = estimate, color = estimate)) +
        geom_sf() +
        scale_fill_viridis_c(name = "Median Income", direction = -1) +
        scale_color_viridis_c(name = "Median Income", direction = -1) +
        labs(title = "Median income distribution in Berkshire County, MA",
             caption = "Source: American Community Survey 2014-2018") +
        theme_void()
```

```{r}
slc_value <- get_acs(geography = "tract", 
                           variables = "B19013_001", 
                           state = "MA",
                           county = "Middlesex County",
                           geometry = TRUE)
saveRDS(slc_value, file = "shiny-app/data/slc_value.rds")

saveRDS(slc_value, file = "shiny-app/data/slc.rds")

```

```{r}
#### MIDDLESEX WRANGLING ####

middlesex_5_years <- read_excel("~/Desktop/Gov-50/court-data/raw_data/Middlesex_2014_to_2019.xlsx")
middlesex_1 <- middlesex_5_years %>% 
  clean_names() %>%
  group_by(case_number) %>%
  mutate(offense_date = as_date(offense_date),
         date_of_filing = as_date(date_of_filing),
         disposition_date = as_date(disposition_date)) 
  
# Calculate difference between date of filing date, offense date, and 
# disposition date

# original data = 343,099 rows 

middlesex_2 <- middlesex_1 %>% 

# filter to only cases that happened and got resolved between 2014-2019
# this leaves us with 285,639 rows 
  
  filter(offense_date >= "2014-01-01", offense_date <= "2019-12-31", 
         date_of_filing >= "2014-01-01", date_of_filing <= "2019-12-31", 
         disposition_date >= "2014-01-01", disposition_date <= "2019-12-31") %>%

# calculate the time lapse between each stage of the case process 
  
  mutate(filing_offense_diff = as.double(difftime(date_of_filing, offense_date, 
                                                  units = "days"))) %>%
  mutate(dispo_offense_diff = as.double(difftime(disposition_date,
                                                       offense_date, 
                                                 units = "days"))) %>% 
  mutate(dispo_filing_diff = as.double(difftime(disposition_date, date_of_filing, 
                                         units = "days"))) %>%
  mutate(total_diff = as.double(difftime(disposition_date, offense_date, 
                                         units = "days"))) %>%
  
# filter to only when the time lapse is bigger than 0
# this is because if time lapse < 0, there is an error 
# in recording the dates 

  filter(filing_offense_diff > 0, 
         dispo_offense_diff > 0, 
         dispo_filing_diff > 0,
         total_diff > 0)

# the results leave us with 191,062 rows
# rename middlesex_2 

# COURT EFFICIENCY ANALYSIS

# Court efficiency measured by cases

# A table summary of cases for each type of court 
middle_table <- middlesex_2 %>%
  mutate(court_location = ifelse(!court_location %in% 
                             c("CAMJU", "FRAJU", "LOWJU", "WALJU",
                                  "LSUP", "MSUP", 
                                  "NA", "OTH"),
                           "District Court", court_location)) %>%
  
  mutate(court_location = ifelse(court_location %in% 
                             c("CAMJU", "FRAJU", "LOWJU", "WALJU"
                                  ),
                           "Juvenile Court", court_location)) %>%
  
  mutate(court_location = ifelse(court_location %in% 
                             c("LSUP", "MSUP"
                                  ),
                           "Superior Court", court_location)) %>% 
  mutate(court_location = ifelse(court_location ==
                             "OTH",
                           "Other", court_location)) %>%
  mutate(court_location = ifelse(court_location ==
                             "NA",
                           "N/A", court_location)) %>%

# select to do unique 
  select(case_number, court_location) %>%

# unique to ensure each case is counted once 
  unique() %>%
  
# 88,651 for all court cases 
  
  group_by(court_location) %>%
  summarize(count = n(), .groups = "drop") %>% 
  arrange(desc(count)) %>% 
  pivot_wider(names_from = court_location, 
              values_from = count)

# We have a table for all cases in each court type in the past 6 years

middle_table %>% gt()

# We look only to investigate cases that go through
# district and superior courts 

## District courts 

middlesex_district <- middlesex_2 %>%

# filter to only district courts
  
    filter(!court_location %in% c("CAMJU", "FRAJU", "LOWJU", "WALJU",
                                  "LSUP", "MSUP", 
                                  "NA", "OTH")) %>%

    select(case_number, court_location, department_filing_charge,
           name_of_judge, filing_offense_diff, dispo_offense_diff, 
           dispo_filing_diff, total_diff, defendant_race, 
           defendant_ethnicity) %>%
    group_by(court_location) %>%

# make sure the same case is not counted more than once 
  
    unique()

# In total, we have 84,148 cases in District Courts in the past 6 years 

## Total Cases by District Courts in Middlesex, MA ##

# We have 12 district courts 

mid_dis <- middlesex_district %>%
  group_by(court_location) %>%
  summarize(count = n(), .groups = "drop") %>%
  arrange(desc(count)) 

saveRDS(mid_dis, file = "shiny-app/data/mid_dis.rds")


mid_dis_plot <- mid_dis %>% 
  ggplot(aes(x = fct_reorder(court_location, count), fill = court_location)) +
    geom_col(aes(y = count)) +
    geom_text(aes(label = comma(count), y = count), nudge_y = 550, size = 3) +
    theme(legend.position = "none") +
    scale_y_continuous(labels = comma_format()) + 
    labs(title = "Total Cases by District Courts in Middlesex, MA",
         subtitle = "Year: 2014-2019",
         x = "",
         y = "") 

mid_dis_plot

## Total Cases by Superior Courts in Middlesex, MA ##

middlesex_sup <- middlesex_2 %>%

    filter(court_location %in% c("LSUP", "MSUP" 
                                  )) %>%

    select(case_number, court_location, department_filing_charge,
           name_of_judge, filing_offense_diff, dispo_offense_diff, total_diff) %>%
    group_by(court_location) %>%
    unique()

mid_sup <- middlesex_sup %>%
  group_by(court_location) %>%
  summarize(count = n(), .groups = "drop") %>%
  arrange(desc(count))

saveRDS(mid_sup, file = "shiny-app/data/mid_sup.rds")


mid_sup_plot <- mid_sup %>% 
  ggplot(aes(x = fct_reorder(court_location, count), fill = court_location)) +
    geom_col(aes(y = count)) +
    geom_text(aes(label = comma(count), y = count), nudge_y = 50, size = 3) +
    theme(legend.position = "none") +
    scale_y_continuous(labels = comma_format()) + 
    labs(title = "Total Cases by Superior Courts in Middlesex, MA",
         subtitle = "Year: 2014-2019",
         x = "",
         y = "") 

mid_sup_plot

```

```{r}
mid_dis <- mid_dis %>%
  mutate(court_location = case_when(
                   court_location == "AYE" ~ "Ayer District Court",
                   court_location == "CAM" ~ "Cambridge District Court",
                   court_location == "CON" ~ "Concord District Court",
                   court_location == "FRA" ~ "Framingham District Court",
                   court_location == "LOW" ~ "Lowell District Court",
                   court_location == "MAL" ~ "Malden District Court",
                   court_location == "MAR" ~ "Marlborough District Court",
                   court_location == "NAT" ~ "Natick District Court",
                   court_location == "NEW" ~ "Newton District Court",
                   court_location == "SOM" ~ "Somerville District Court",
                   court_location == "WAL" ~ "Waltham District Court",
                   court_location == "WOB" ~ "Woburn District Court",
                   TRUE ~ "Yes"
                   )) %>%
  rename(district_court = court_location)
```


```{r}
# How many days does it take for each court? 


middlesex_district %>%
  filter(court_location == "LOW") %>%
  pivot_longer(cols = c(filing_offense_diff, dispo_offense_diff, total_diff),
               names_to = "time stage",
               values_to = "value") %>%
  group_by(case_number) 

# currently, middlesex_district has 84,148 rows or 84,148 total cases 

m <- middlesex_district %>%
  mutate(defendant_race = case_when(defendant_race == "W" ~ "White",
                          defendant_race == "B" ~ "Black",
                          defendant_race == "H" ~ "Hispanic",
                          TRUE ~ "Other")) %>%
  mutate(defendant_ethnicity = ifelse(defendant_ethnicity == "HL",
                                      "Hispanic",
                                      "non-Hispanic")) %>%
  group_by(court_location, defendant_race) %>%
  summarize(count = n(), .groups = "drop") %>%
  pivot_wider(names_from = defendant_race, values_from = count
              ) %>%
  clean_names() %>%
  mutate(court_location = case_when(
                   court_location == "AYE" ~ "Ayer District Court",
                   court_location == "CAM" ~ "Cambridge District Court",
                   court_location == "CON" ~ "Concord District Court",
                   court_location == "FRA" ~ "Framingham District Court",
                   court_location == "LOW" ~ "Lowell District Court",
                   court_location == "MAL" ~ "Malden District Court",
                   court_location == "MAR" ~ "Marlborough District Court",
                   court_location == "NAT" ~ "Natick District Court",
                   court_location == "NEW" ~ "Newton District Court",
                   court_location == "SOM" ~ "Somerville District Court",
                   court_location == "WAL" ~ "Waltham District Court",
                   court_location == "WOB" ~ "Woburn District Court",
                   TRUE ~ "Yes"
                   )) %>%
  rename(district_court = court_location)



m
  

```

```{r}
uszips <- read_excel("raw_data/uszips.xlsx")

uszips_mid <- uszips %>% 
                filter(state_id == "MA", county_name == "Middlesex")

city_and_court <- read_excel("raw_data/city and court.xlsx")
city_and_court

# Racial disparity 
# Total population each court served

# Race as % Total population all district courts served 
# Race as % Total cases all district courts handled 
join_pop <- inner_join(uszips_mid, city_and_court, by = "city")


glimpse(join_pop)

# total population served by court 

total_pop <- join_pop %>% select(population, district_court, city) %>%
  group_by(district_court) %>%
  summarise(sum = sum(population), .groups = "drop") %>%
  mutate(district_court = ifelse(district_court == "Somerville District Court Office",
                                 "Somerville District Court",
                                 district_court))
#mutate(ratio = count/sum) %>% 
# mutate(district_court = fct_reorder(district_court, ratio)) %>%

sum_count_mid <- left_join(mid_dis, total_pop, 
                           by = "district_court") %>%
 mutate(district_court = fct_reorder(as_factor(district_court), count)) %>%     pivot_longer(cols = c(count, sum), 
                                 names_to = "ratio", 
                                 values_to = "number") %>%
                    ggplot(aes(x = district_court, 
                               y = number, 
                               fill = forcats::fct_rev(ratio))) +
  geom_col(position = "fill") +
  labs(title = "Cases by Total Population served",
       subtitle = "District courts, Middlesex County",
       x = "",
       y = "Population") +
  scale_fill_manual(name = "",
                    values = c("red", "blue"),
                    breaks = c("count", "sum"),
                    labels = c("Total cases", "Population served")) +
  scale_y_continuous(labels = percent_format()) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  coord_flip()

sum_count_mid 
  


# Race as % Total population each court served 
# Race as % Total cases each court handled 

```

```{r race by court}
race <- get_acs(geography = "zcta", 
                           variables = c(White = "B03002_003", 
                                         Black = "B03002_004",
                      Asian = "B03002_006", Hispanic = "B03002_012"), 
                           
                           geometry = TRUE)

glimpse(race)

race <- race %>% 
  rename(zip = GEOID) %>%
  mutate(zip = as.double(zip))

pop_race <- left_join(join_pop, race, by = "zip")

# get total population 
pop_race_total <- pop_race %>%
  pivot_wider(id_cols = c(zip, district_court), names_from = variable, values_from = estimate) %>%
  group_by(district_court) %>%
  summarize(total_white = sum(White),
            total_black = sum(Black),
            total_asian = sum(Asian),
            total_hispanic = sum(Hispanic),
            .groups = "drop") %>%
  mutate(district_court = ifelse(district_court == "Somerville District Court Office",
                                 "Somerville District Court",
                                 district_court))

# get population percentile 
pop_race_percent <- pop_race_total %>%
  mutate(percent_white = total_white/total_population,
         percent_black = total_black/total_population,
         percent_asian = total_asian/total_population,
         percent_hispanic = total_hispanic/total_population) 



mid_join_race <- left_join(pop_race_total, m, by = "district_court")

mid_race_percent <- mid_join_race %>%
  mutate(percent_white = white/total_white,
         percent_black = black/total_black,
         percent_hispanic = hispanic/total_hispanic) %>%
  select(district_court, percent_white, percent_black, percent_hispanic) %>%
  pivot_longer(cols = c("percent_black", "percent_white", "percent_hispanic"),
               names_to = "percent_race",
               values_to = "percent")


saveRDS(mid_race_percent, file = "shiny-app/data/mid_race_percent.rds")

pop_race_total

pop_race_percent <- left_join(pop_race_total, 
                              total_pop, by = "district_court") %>%
  mutate(black_percent = total_black/sum,
         white_percent = total_white/sum,
         hispanic_percent = total_hispanic/sum) %>%
  select(district_court, black_percent, white_percent, hispanic_percent)

  


```

```{r}

```

