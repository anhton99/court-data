---
title: "gather"
author: "Anh"
date: "10/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(readxl)
library(janitor)
library(tidycensus)
library(viridis)
library(lubridate)
library(janitor)
library(scales)

```

```{r juvenile}
juvenile_stats_2014 <- read_excel("raw_data/Juvenile_stats_2014.xlsx") %>%
  clean_names() %>% 
  select(!total) %>%
  mutate(year = 2014)

juvenile_stats_2015 <- read_excel("raw_data/Juvenile_stats_2015.xlsx") %>%
  clean_names() %>% 
  select(!grand_total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2015)

juvenile_stats_2016 <- read_excel("raw_data/Juvenile_stats_2016.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2016) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_stats_2017 <- read_excel("raw_data/Juvenile_stats_2017.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_stats_2018 <- read_excel("raw_data/Juvenile_stats_2018.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2018) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_stats_2019 <- read_excel("raw_data/Juvenile_stats_2019.xlsx") %>%
  clean_names() %>%
  select(!total) %>%
  rename(barnstable = barnstable_town_of_plymouth) %>%
  mutate(year = 2019) %>%
  mutate(suffolk = round(suffolk),
         bristol = round(bristol),
         essex = round(essex),
         hampden = round(hampden),
         middlesex = round(middlesex),
         worcester = round(worcester))

juvenile_6_years <- 
  bind_rows(list(juvenile_stats_2014, juvenile_stats_2015,
                 juvenile_stats_2016, juvenile_stats_2017,
                 juvenile_stats_2018, juvenile_stats_2019),
            .id = "year") %>% 
  mutate(year = as.numeric(year) + 2013) %>%
  group_by(year)

saveRDS(juvenile_stats_2014, file = "shiny-app/data/juvenile_stats_2014.rds")
saveRDS(juvenile_6_years, file = "shiny-app/data/juvenile_6_years.rds")
```


```{r county}
# Find variables in ACS
variable_code <- load_variables(2018, "acs5", cache = TRUE)
View(variable_code)

# Getting American Community Survey data 2014-2018
# Median income by county
county_income <- get_acs(geography = "county",
              variables = c(medincome = "B19013_001"),
              state = "MA",
              year = 2018)

glimpse(county_income)

get_acs(geography = "county",
              variables = c(medincome = "B19013_001"),
              state = "MA",
              year = 2018) %>%
  mutate(NAME = gsub(" County, Massachusetts", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 1) +
  labs(title = "Household income by county in MA",
       subtitle = "2014-2018 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")

#margin of error is small for Berkshire and Middlesex county. For Middlesex, median household income according to 2014-2018 American Community Survey fell between 95,000 and 100,000 US dollars. For Berkshire, median household income fell between 55,000 and 60,000 US dollars per year. In other words, median household income in Berkshire is roughly half of the median household income in Middlesex. 

```
```{r middlesex}
# racial population by county
racial_variables <- c(White = "B03002_003", Black = "B03002_004",
                      Asian = "B03002_006", Hispanic = "B03002_012")

county_race <- get_acs(geography = "county",
                       state = "MA",
                       variables = racial_variables,
                       summary_var = "B03002_001",
                       year = 2018) %>%
  filter(NAME == "Middlesex County, Massachusetts")
glimpse(county_race)

#racial proportion by county 
county_race_prop <- county_race %>%
  mutate(pct = 100 * (estimate/summary_est)) %>%
  select(NAME, variable, pct)

county_race_prop

# middlesex racial proportion
middlesex_race <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Middlesex County",
                  geometry = TRUE,
                  summary_var = "B03002_001")
middlesex_race

middlesex_race_map <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Middlesex County",
                  geometry = TRUE,
                  summary_var = "B03002_001") %>%
  mutate(Percent = 100 * (estimate / summary_est)) %>%
  ggplot(aes(fill = Percent, color = Percent)) +
  facet_wrap(~ variable) +
  geom_sf() +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) +
  labs(title = "Racial geography of Middlesex County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

middlesex_race_map
```

```{r berkshire}
# berkshire racial proportion

berkshire_race <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Berkshire County",
                  geometry = TRUE,
                  summary_var = "B03002_001")
berkshire_race

berkshire_race_map <- get_acs(geography = "tract",
                  variables = racial_variables, 
                  year = 2018,
                  state = "MA",
                  county = "Berkshire County",
                  geometry = TRUE,
                  summary_var = "B03002_001") %>%
  mutate(Percent = 100 * (estimate / summary_est)) %>%
  ggplot(aes(fill = Percent, color = Percent)) +
  facet_wrap(~ variable) +
  geom_sf() +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) +
  labs(title = "Racial geography of Berkshire County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

berkshire_race_map

```

```{r incomemap}

# Median Income value for Middlesex 

middlesex_income_value <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Middlesex County",
                    geometry = TRUE)

middlesex_income_map <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Middlesex County",
                    geometry = TRUE) %>%
  ggplot(aes(fill = estimate, color = estimate)) +
  geom_sf() +
  scale_fill_viridis_c(name = "Median Income", direction = -1) +
  scale_color_viridis_c(name = "Median Income", direction = -1) +
  labs(title = "Median income distribution in Middlesex County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

middlesex_income_map


```

```{r}
# Median Income value for Berkshire 

berkshire_income_value <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Berkshire County",
                    geometry = TRUE)

berkshire_income_map <- get_acs(geography = "tract", 
                    variables = "B19013_001", 
                    state = "MA",
                    county = "Berkshire County",
                    geometry = TRUE) %>%
  ggplot(aes(fill = estimate, color = estimate)) +
  geom_sf() +
  scale_fill_viridis_c(name = "Median Income", direction = -1) +
  scale_color_viridis_c(name = "Median Income", direction = -1) +
  labs(title = "Median income distribution in Berkshire County, MA",
       caption = "Source: American Community Survey 2014-2018") +
  theme_void()

berkshire_income_map
```

```{r}
  
          # berkshire racial geography map
      
      berkshire_race_map <- get_acs(geography = "tract",
                                    variables = racial_variables, 
                                    year = 2018,
                                    state = "MA",
                                    county = "Berkshire County",
                                    geometry = TRUE,
                                    summary_var = "B03002_001") %>%
        mutate(Percent = 100 * (estimate / summary_est)) %>%
        ggplot(aes(fill = Percent, color = Percent)) +
        facet_wrap(~ variable) +
        geom_sf() +
        scale_fill_viridis_c(direction = -1) +
        scale_color_viridis_c(direction = -1) +
        labs(title = "Racial geography of Berkshire County, MA",
             caption = "Source: American Community Survey 2014-2018") +
        theme_void()
      # middlesex income
      middlesex_income_map <- get_acs(geography = "tract", 
                                      variables = "B19013_001", 
                                      state = "MA",
                                      county = "Middlesex County",
                                      geometry = TRUE) %>%
        ggplot(aes(fill = estimate, color = estimate)) +
        geom_sf() +
        scale_fill_viridis_c(name = "Median Income", direction = -1) +
        scale_color_viridis_c(name = "Median Income", direction = -1) +
        labs(title = "Median income distribution in Middlesex County, MA",
             caption = "Source: American Community Survey 2014-2018") +
        theme_void()
      
      # berkshire income 
      berkshire_income_map <- get_acs(geography = "tract", 
                                      variables = "B19013_001", 
                                      state = "MA",
                                      county = "Berkshire County",
                                      geometry = TRUE) %>%
        ggplot(aes(fill = estimate, color = estimate)) +
        geom_sf() +
        scale_fill_viridis_c(name = "Median Income", direction = -1) +
        scale_color_viridis_c(name = "Median Income", direction = -1) +
        labs(title = "Median income distribution in Berkshire County, MA",
             caption = "Source: American Community Survey 2014-2018") +
        theme_void()
```

```{r}
slc_value <- get_acs(geography = "tract", 
                           variables = "B19013_001", 
                           state = "MA",
                           county = "Middlesex County",
                           geometry = TRUE)

saveRDS(slc_value, file = "shiny-app/data/slc.rds")

```

```{r}
#### MIDDLESEX WRANGLING ####

middlesex_5_years <- read_excel("~/Desktop/Gov-50/court-data/raw_data/Middlesex_2014_to_2019.xlsx")
middlesex_1 <- middlesex_5_years %>% 
  clean_names() %>%
  group_by(case_number) %>%
  mutate(offense_date = as_date(offense_date),
         date_of_filing = as_date(date_of_filing),
         disposition_date = as_date(disposition_date)) 
  
# Calculate difference between date of filing date, offense date, and 
# disposition date

# original data = 343,099 rows 
middlesex_2 <- middlesex_1 %>% 

# filter to only cases that happened and got resolved between 2014-2019
# this leaves us with 285,639 rows 
  
  filter(offense_date >= "2014-01-01", offense_date <= "2019-12-31", 
         date_of_filing >= "2014-01-01", date_of_filing <= "2019-12-31", 
         disposition_date >= "2014-01-01", disposition_date <= "2019-12-31") %>%

# calculate the time lapse between each stage of the case process 
  
  mutate(filing_offense_diff = as.double(difftime(date_of_filing, offense_date, 
                                                  units = "days"))) %>%
  mutate(dispo_offense_diff = as.double(difftime(disposition_date,
                                                       offense_date, 
                                                 units = "days"))) %>% 
  mutate(total_diff = as.double(difftime(disposition_date, date_of_filing, 
                                         units = "days"))) %>%
  
# filter to only when the time lapse is bigger than 0
# this is because if time lapse < 0, there is an error 
# in recording the dates 

  filter(filing_offense_diff > 0, 
         dispo_offense_diff > 0, 
         total_diff > 0)

# the results leave us with 191,062 rows
# rename middlesex_2 

# COURT EFFICIENCY ANALYSIS

# Court efficiency measured by cases

# A table summary of cases for each type of court 
middle_table <- middlesex_2 %>%
  mutate(court_location = ifelse(!court_location %in% 
                             c("CAMJU", "FRAJU", "LOWJU", "WALJU",
                                  "LSUP", "MSUP", 
                                  "NA", "OTH"),
                           "District Court", court_location)) %>%
  
  mutate(court_location = ifelse(court_location %in% 
                             c("CAMJU", "FRAJU", "LOWJU", "WALJU"
                                  ),
                           "Juvenile Court", court_location)) %>%
  
  mutate(court_location = ifelse(court_location %in% 
                             c("LSUP", "MSUP"
                                  ),
                           "Superior Court", court_location)) %>% 
  mutate(court_location = ifelse(court_location ==
                             "OTH",
                           "Other", court_location)) %>%
  mutate(court_location = ifelse(court_location ==
                             "NA",
                           "N/A", court_location)) %>%

# select to do unique 
  select(case_number, court_location) %>%

# unique to ensure each case is counted once 
  unique() %>%
  
# 88,651 for all court cases 
  
  group_by(court_location) %>%
  summarize(count = n(), .groups = "drop") %>% 
  arrange(desc(count)) %>% 
  pivot_wider(names_from = court_location, 
              values_from = count)

# We have a table for all cases in each court type in the past 6 years

middle_table

# We look only to investigate cases that go through
# district and superior courts 

## District courts 

middlesex_district <- middlesex_2 %>%

# filter to only district courts
  
    filter(!court_location %in% c("CAMJU", "FRAJU", "LOWJU", "WALJU",
                                  "LSUP", "MSUP", 
                                  "NA", "OTH")) %>%

    select(case_number, court_location, department_filing_charge,
           name_of_judge, filing_offense_diff, dispo_offense_diff, total_diff) %>%
    group_by(court_location) %>%

# make sure the same case is not counted more than once 
  
    unique()

# In total, we have 84,504 cases in District Courts in the past 6 years 

## Total Cases by District Courts in Middlesex, MA ##

# We have 12 district courts 

mid_dis <- middlesex_district %>%
  group_by(court_location) %>%
  summarize(count = n(), .groups = "drop") %>%
  arrange(desc(count)) 

mid_dis_plot <- mid_dis %>% 
  ggplot(aes(x = fct_reorder(court_location, count), fill = court_location)) +
    geom_col(aes(y = count)) +
    geom_text(aes(label = comma(count), y = count), nudge_y = 550, size = 3) +
    theme(legend.position = "none") +
    scale_y_continuous(labels = comma_format()) + 
    labs(title = "Total Cases by District Courts in Middlesex, MA",
         subtitle = "Year: 2014-2019",
         x = "",
         y = "") 

mid_dis_plot

## Total Cases by Superior Courts in Middlesex, MA ##

middlesex_sup <- middlesex_2 %>%

    filter(court_location %in% c("LSUP", "MSUP" 
                                  )) %>%

    select(case_number, court_location, department_filing_charge,
           name_of_judge, filing_offense_diff, dispo_offense_diff, total_diff) %>%
    group_by(court_location) %>%
    unique()

mid_sup <- middlesex_sup %>%
  group_by(court_location) %>%
  summarize(count = n(), .groups = "drop") %>%
  arrange(desc(count))

mid_sup_plot <- mid_sup %>% 
  ggplot(aes(x = fct_reorder(court_location, count), fill = court_location)) +
    geom_col(aes(y = count)) +
    geom_text(aes(label = comma(count), y = count), nudge_y = 50, size = 3) +
    theme(legend.position = "none") +
    scale_y_continuous(labels = comma_format()) + 
    labs(title = "Total Cases by Superior Courts in Middlesex, MA",
         subtitle = "Year: 2014-2019",
         x = "",
         y = "") 

mid_sup_plot

```

Bershire

```{r}
berkshire_2014_2018 <- read_excel("raw_data/1 Berkshire DA - ACLU Prosecution Data 1, 2 and 4 .xlsx")
View(berkshire_2014_2018)

berkshire_2014_2018 <- berkshire_2014_2018 %>% 
  clean_names() %>%
  rename(case_disposition = case_dspstn,
         charge_disposition = charge_dspstn,
         case_status = d_cs_status)

berkshire_2014_2018

unique(berkshire_2014_2018$case_status)

```

